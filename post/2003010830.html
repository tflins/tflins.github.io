<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 3.9.0"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><title>谈谈原生 Ajax - 枫林晚记</title><meta name="description" content="前言之前写 Ajax 交互，都是使用已经封装好的库，今天就来聊聊原生的 Ajax。 Ajax 就是 Asynchronous JavaScript + XML 的简写，这一技术能向服务器请求额外的数据而无需重载页面。也就是用户无需刷新页面，便能从服务器获取数据的更新，这样能使用户得到更好的体验。比如有时候，会有这样的一个需求：只想要改变页面的某个区域。而以前的技术只能通过刷新页面来实现，向服务器重"><meta name="keywords" content="JavaScript,Ajax"><meta property="og:type" content="article"><meta property="og:title" content="谈谈原生 Ajax"><meta property="og:url" content="https://tflin.com/post/2003010830.html"><meta property="og:site_name" content="枫林晚记"><meta property="og:description" content="前言之前写 Ajax 交互，都是使用已经封装好的库，今天就来聊聊原生的 Ajax。 Ajax 就是 Asynchronous JavaScript + XML 的简写，这一技术能向服务器请求额外的数据而无需重载页面。也就是用户无需刷新页面，便能从服务器获取数据的更新，这样能使用户得到更好的体验。比如有时候，会有这样的一个需求：只想要改变页面的某个区域。而以前的技术只能通过刷新页面来实现，向服务器重"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://tflin.com/images/og_image.png"><meta property="og:updated_time" content="2021-06-23T02:15:29.739Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="谈谈原生 Ajax"><meta name="twitter:description" content="前言之前写 Ajax 交互，都是使用已经封装好的库，今天就来聊聊原生的 Ajax。 Ajax 就是 Asynchronous JavaScript + XML 的简写，这一技术能向服务器请求额外的数据而无需重载页面。也就是用户无需刷新页面，便能从服务器获取数据的更新，这样能使用户得到更好的体验。比如有时候，会有这样的一个需求：只想要改变页面的某个区域。而以前的技术只能通过刷新页面来实现，向服务器重"><meta name="twitter:image" content="https://tflin.com/images/og_image.png"><link rel="icon" href="/images/favicon.svg"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.4.1/css/all.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><link rel="stylesheet" href="/css/back-to-top.css"><link rel="stylesheet" href="/css/progressbar.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><link rel="stylesheet" href="/css/style.css"><meta name="referrer" content="no-referrer"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand is-flex-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/logo.png" alt="谈谈原生 Ajax" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" target="_self" href="/">首页</a> <a class="navbar-item" target="_self" href="/archives/">归档</a> <a class="navbar-item" target="_self" href="/categories/">分类</a> <a class="navbar-item" target="_self" href="/tags/">标签</a> <a class="navbar-item" target="_self" href="/chitchat/">闲言</a> <a class="navbar-item" target="_self" href="/about/">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" title="Download on GitHub" href="https://github.com/tflins"><i class="fab fa-github"></i> </a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i> </a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column is-8-tablet is-8-desktop is-9-widescreen has-order-2 column-main"><div class="card"><div class="card-content article"><h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal"><i class="fas fa-angle-double-right"></i>谈谈原生 Ajax</h1><div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto"><div class="level-left"><time class="level-item has-text-grey" datetime="2018-08-25T09:21:39.000Z"><i class="far fa-calendar-alt">&nbsp;</i>2018-08-25</time><div class="level-item"><a class="has-link-grey -link" href="/categories/前端/">前端</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/前端/JavaScript/">JavaScript</a></div><span class="level-item has-text-grey">17 分钟 读完 (大约 2595 个字)</span></div></div><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前写 Ajax 交互，都是使用已经封装好的库，今天就来聊聊原生的 Ajax。 Ajax 就是 Asynchronous JavaScript + XML 的简写，这一技术能向服务器请求额外的数据而无需重载页面。也就是用户无需刷新页面，便能从服务器获取数据的更新，这样能使用户得到更好的体验。比如有时候，会有这样的一个需求：只想要改变页面的某个区域。而以前的技术只能通过刷新页面来实现，向服务器重新请求页面，这样会增加多余的一些请求，从而影响性能。而 Ajax 则是为了解决这一问题诞生的，是网页无需刷新页面，使用 JavaScript 与服务器进行交互的一种技术。</p><a id="more"></a><hr><h2 id="XMLHttpRequest-对象"><a href="#XMLHttpRequest-对象" class="headerlink" title="XMLHttpRequest 对象"></a>XMLHttpRequest 对象</h2><p>Ajax 技术的核心是 XMLHttpRequest 对象（简称 XHR），XHR 为向服务器发送请求和解析服务器的响应提供了相当流畅的接口。<br>IE7+、 Firefox、 Opera、 Chrome 和 Safari 都支持原生的 XHR 对象，在这些浏览器中创建 XHR 对象只需 new 一下即可。</p><figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> xhr = <span class="hljs-keyword">new</span> XMLHttpResquest()</span><br></pre></td></tr></table></figure><p>当然，如果在更早的 IE 版本（可恶）中使用 XHR，就需要自定义一个创建 XHR 对象的方法了，同时在 IE11 之前也不能使用 ES6 的语法，所以就如同下面这般，先判断 XHR 是否存在：</p><figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createXHR</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// IE7+、Firefox、 Opera、 Chrome 和 Safari···</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.XMLHttpRequset) &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> XMLHttpRequset()</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">    <span class="hljs-comment">// 兼容IE5、IE6</span></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ActiveXObject(<span class="hljs-string">'Microsoft.XMLHTTP'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-keyword">var</span> XHR = createXHR()</span><br></pre></td></tr></table></figure><hr><h2 id="XHR-的用法"><a href="#XHR-的用法" class="headerlink" title="XHR 的用法"></a>XHR 的用法</h2><h3 id="open-方法："><a href="#open-方法：" class="headerlink" title="open() 方法："></a>open() 方法：</h3><p>在使用 XHR 时，<strong>第一个调用的方法就是 open(method, url, async)</strong>，该方法接受三个参数：第一个就是发送的请求的类型如 GET 、POST 等，第二个则是提交的 url，第三个为是否异步发送的布尔值，默认为 true。<br>如</p><figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xhr.open(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'/api/login'</span>, <span class="hljs-literal">false</span>)</span><br></pre></td></tr></table></figure><p>这行代码会启动一个针对 /api/login 的 GET 的请求，以同步的方式执行，不过调用 open() 并不会真正的去发送一个请求，而是启动一个请求准备发送。</p><h3 id="send-方法"><a href="#send-方法" class="headerlink" title="send() 方法"></a>send() 方法</h3><p><strong>要想真正的发送一个请求就得调用 send(String) 方法，</strong>该方法接受一个参数，即请求主题发送的数据。<br>在红宝石一书中提到过：<strong>如果不需要通过请求主体发送数据，则必须传入 null ，因为这个参数对有些浏览器来说是必需的</strong>。<br>如</p><figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xhr.open(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'test.txt'</span>, <span class="hljs-literal">false</span>)</span><br><span class="line">xhr.send(<span class="hljs-literal">null</span>)</span><br></pre></td></tr></table></figure><h3 id="响应数据"><a href="#响应数据" class="headerlink" title="响应数据"></a>响应数据</h3><p>收到服务器响应后，响应会自动填充为 XHR 对象的属性，相关属性为下表：</p><table><thead><tr><th>属性名</th><th>说明</th></tr></thead><tbody><tr><td>responseText</td><td>作为响应主体被返回的文本</td></tr><tr><td>responseXML</td><td>如果响应的内容类型是 XML，<br>这个属性中将保存包含着响应数据的 XML DOM 文档。<br>对于非 XML 数据而言， responseXML 属性的值将为 null</td></tr><tr><td>status</td><td>响应的 HTTP 状态</td></tr><tr><td>statusText</td><td>HTTP 状态的说明</td></tr></tbody></table><p>在接受响应后，<strong>首先要检查的是 status 属性</strong>，以确保相应已经成功返回。一般是将 HTTP 状态码 200 作为请求成功的标志，不过状态码为 304 意味着请求的资源没有被修改，可以直接使用浏览器缓存的版本，所以 304 也表示请求成功。请求成功以后 responseText 属性的内容就已经准备就绪了。<br>如</p><figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">xhr.open(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'test.txt'</span>, <span class="hljs-literal">false</span>)</span><br><span class="line">xhr.send(<span class="hljs-literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (xhr.status === <span class="hljs-number">200</span> || xhr.status === <span class="hljs-number">304</span>) &#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(xhr.responseText)</span><br><span class="line">&#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'请求出错，状态码为：'</span> + xhr.status)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="onreadystatechange-事件与-readyState-属性"><a href="#onreadystatechange-事件与-readyState-属性" class="headerlink" title="onreadystatechange 事件与 readyState 属性"></a>onreadystatechange 事件与 readyState 属性</h3><p>XHR 对象的 readyState 属性是表示当前 请求/响应 的状态，该属性的值及说明为下表：</p><table><thead><tr><th>值</th><th>描述</th></tr></thead><tbody><tr><td>0</td><td>未初始化，尚未调用 open() 方法</td></tr><tr><td>1</td><td>启动，已经调用 open()方法，但尚未调用 send()方法</td></tr><tr><td>2</td><td>发送，已经调用 send()方法，但尚未接收到响应</td></tr><tr><td>3</td><td>接收，已经接收到部分响应数据</td></tr><tr><td>4</td><td>完成，已经接收到全部响应数据，而且已经可以在客户端使用了</td></tr></tbody></table><p>每当 readyState 属性的值发生改变的时候，会触发一次 readystatechange 事件。也就是说，我们可以通过 readystatechange 事件来监听 readyState 属性的值。当 readyState 的值为 4 的时候，说明整个过程已经完成，就可以继续进行后续的数据处理。<br>如</p><figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest()</span><br><span class="line">xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (xhr.readyState === <span class="hljs-number">4</span>) &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (xhr.status === <span class="hljs-number">200</span> || xhr.status === <span class="hljs-number">304</span>) &#123;</span><br><span class="line">      <span class="hljs-built_in">console</span>.log(xhr.responseText)</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'请求出错，状态码为：'</span> + xhr.status)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">xhr.open(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'/api/xxx'</span>)</span><br><span class="line">xhr.send(<span class="hljs-literal">null</span>)</span><br></pre></td></tr></table></figure><p>在调用 open() 之前指定 onreadystatechange 事件处理程序和使用 xhr 而不是 this 是为了保存浏览器的兼容性。</p><h3 id="setRequestHeader-、getResponseHeader-与-getAllResponseHeaders-方法"><a href="#setRequestHeader-、getResponseHeader-与-getAllResponseHeaders-方法" class="headerlink" title="setRequestHeader() 、getResponseHeader() 与 getAllResponseHeaders() 方法"></a>setRequestHeader() 、getResponseHeader() 与 getAllResponseHeaders() 方法</h3><p>setRequestHeader() 方法可以设置自定义的 HTTP 请求头部信息，该方法接受两个参数：第一个为头部字段的名称，第二个为头部字段的值。<strong>必须在 open() 和 send() 之间调用才能成功发送头部信息</strong>。<br>如</p><figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xhr.open(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'/api/xxx'</span>)</span><br><span class="line">xhr.setRequestHeader(<span class="hljs-string">'MyHeader'</span>, <span class="hljs-string">'MyValue'</span>)</span><br><span class="line">xhr.send(<span class="hljs-literal">null</span>)</span><br></pre></td></tr></table></figure><p>getResponseHeader(“String”) 方法接受一个参数，传入头部字段名称，可以取得相应的响应头部信<br>息。<br>getAllResponseHeaders() 方法则可以取得一个包含所有头部信息的长字符串。<br>如</p><figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> myHeader = xhr.getResponseHeader(<span class="hljs-string">'MyHeader'</span>)</span><br><span class="line"><span class="hljs-keyword">let</span> allHeaders = xhr.getAllResponseHeaders()</span><br></pre></td></tr></table></figure><hr><h2 id="GET-请求"><a href="#GET-请求" class="headerlink" title="GET 请求"></a>GET 请求</h2><p>GET 是最常见的请求类型，一般用于查询某些信息。<br>原生 Ajax 处理如下</p><figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 1.创建 XHR 对象</span></span><br><span class="line"><span class="hljs-keyword">let</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest()</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 4.注册事件 onreadystatechange ，readyState 属性状态改变就会调用</span></span><br><span class="line">xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="hljs-comment">// 监听 readyState 的值</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (xhr.readyState === <span class="hljs-number">4</span>) &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (xhr.status === <span class="hljs-number">200</span> || xhr.status === <span class="hljs-number">304</span>) &#123;</span><br><span class="line">      <span class="hljs-comment">// 5.如果进到这里，说明请求与响应完成，可以继续进行其他处理</span></span><br><span class="line">      <span class="hljs-built_in">console</span>.log(xhr.responseText)</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">      <span class="hljs-comment">// 其他问题</span></span><br><span class="line">      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'请求出错，状态码为：'</span> + xhr.status)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 2.启动一个请求，url最好使用 encodeURI 处理一下，以防出现乱码</span></span><br><span class="line">xhr.open(<span class="hljs-string">'GET'</span>, url)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 3.发送请求</span></span><br><span class="line">xhr.send(<span class="hljs-literal">null</span>)</span><br></pre></td></tr></table></figure><hr><h2 id="POST-请求"><a href="#POST-请求" class="headerlink" title="POST 请求"></a>POST 请求</h2><p>POST 请求使用频率仅此于 GET，一般用于向服务器发送需要保存的数据。POST 请求是将数据作为请求主体来提交，这点不同于 GET 。POST 请求的主体可以包含很多的数据，并且格式不限。<br>如</p><figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 1.创建 XHR 对象</span></span><br><span class="line"><span class="hljs-keyword">let</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest()</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 4.注册事件 onreadystatechange ，readyState 属性状态改变就会调用</span></span><br><span class="line">xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="hljs-comment">// 监听 readyState 的值</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (xhr.readyState === <span class="hljs-number">4</span>) &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (xhr.status === <span class="hljs-number">200</span> || xhr.status === <span class="hljs-number">304</span>) &#123;</span><br><span class="line">      <span class="hljs-comment">// 3.如果进到这里，说明请求与响应完成，可以继续进行其他处理</span></span><br><span class="line">      <span class="hljs-built_in">console</span>.log(xhr.responseText)</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">      <span class="hljs-comment">// 其他问题</span></span><br><span class="line">      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'请求出错，状态码为：'</span> + xhr.status)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 2.启动一个请求，并设置请求地址</span></span><br><span class="line">xhr.open(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'/api/xxx'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// post方式传递数据是模仿form表单传递给服务器的,要设置header头协议</span></span><br><span class="line">xhr.setRequestHeader(<span class="hljs-string">'content-type'</span>, <span class="hljs-string">'application/x-www-form-urlencoded'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 3.发送请求</span></span><br><span class="line"><span class="hljs-keyword">let</span> info = <span class="hljs-string">'username='</span> + <span class="hljs-string">'xxx'</span> + <span class="hljs-string">'&amp;email='</span> + <span class="hljs-string">'xxx'</span></span><br><span class="line">xhr.send(info)</span><br></pre></td></tr></table></figure><hr><h2 id="封装-Ajax"><a href="#封装-Ajax" class="headerlink" title="封装 Ajax"></a>封装 Ajax</h2><p>不过不能每次使用都要这样啰嗦一堆，所以我在这里将 Ajax 进行封装。既然进行了封装，就说明以后可能会用得到，所以就要保证浏览器兼容性，同时采用 ES5 的语法。</p><figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment"> *	封装原生 Ajax</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> *	参数说明：</span></span><br><span class="line"><span class="hljs-comment"> *	options = &#123;</span></span><br><span class="line"><span class="hljs-comment"> *		url		提交请求的url</span></span><br><span class="line"><span class="hljs-comment"> *		type	请求的类型，默认为GET</span></span><br><span class="line"><span class="hljs-comment"> *		data	请求体的数据</span></span><br><span class="line"><span class="hljs-comment"> *		async	是否以异步方式进行，默认为true</span></span><br><span class="line"><span class="hljs-comment"> *		success	成功后的处理方法</span></span><br><span class="line"><span class="hljs-comment"> *		error	失败后的处理方法</span></span><br><span class="line"><span class="hljs-comment"> *	&#125;</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ajax</span>(<span class="hljs-params">options</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// 传入默认为对象</span></span><br><span class="line">  <span class="hljs-keyword">var</span> options = options || &#123;&#125;</span><br><span class="line">  <span class="hljs-comment">// 请求类型默认为 GET</span></span><br><span class="line">  options.type = options.type.toUpperCase() || <span class="hljs-string">'GET'</span></span><br><span class="line">  <span class="hljs-comment">// 默认为异步请求</span></span><br><span class="line">  options.async = options.async || <span class="hljs-literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 格式化参数的函数</span></span><br><span class="line">  <span class="hljs-keyword">var</span> getParams = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">var</span> arr = []</span><br><span class="line">    <span class="hljs-keyword">for</span> (param <span class="hljs-keyword">in</span> data) &#123;</span><br><span class="line">      <span class="hljs-comment">//查询字符串中每个参数的名称和值都必须使用 encodeURIComponent()进行编码</span></span><br><span class="line">      arr.push(</span><br><span class="line">        <span class="hljs-built_in">encodeURIComponent</span>(param) + <span class="hljs-string">'='</span> + <span class="hljs-built_in">encodeURIComponent</span>(data[param])</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// 在 url 末尾加上一个随机数，避免相同值使用 IE 缓存</span></span><br><span class="line">    arr.push((<span class="hljs-string">'randomNum='</span> + <span class="hljs-built_in">Math</span>.random()).replace(<span class="hljs-string">'.'</span>, <span class="hljs-string">''</span>))</span><br><span class="line">    <span class="hljs-comment">// 返回带有 &amp; 的查询字符串</span></span><br><span class="line">    <span class="hljs-keyword">return</span> arr.join(<span class="hljs-string">'&amp;'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 格式化数据</span></span><br><span class="line">  <span class="hljs-keyword">var</span> params = getParams(options.data)</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">   * 创建 XHR 对象</span></span><br><span class="line"><span class="hljs-comment">   * 兼容 IE5、IE6</span></span><br><span class="line"><span class="hljs-comment">   */</span></span><br><span class="line">  <span class="hljs-keyword">var</span> xhr = <span class="hljs-built_in">window</span>.XMLHttpRequest</span><br><span class="line">    ? <span class="hljs-keyword">new</span> XMLHttpRequest()</span><br><span class="line">    : <span class="hljs-keyword">new</span> ActiveXObject(<span class="hljs-string">'Microsoft.XMLHTTP'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 为 xhr 注册事件 onreadystatechange ，当 readyState 属性状态改变就会触发该事件</span></span><br><span class="line">  xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (xhr.readyState === <span class="hljs-number">4</span>) &#123;</span><br><span class="line">      <span class="hljs-keyword">if</span> (xhr.status === <span class="hljs-number">200</span> || xhr.status === <span class="hljs-number">304</span>) &#123;</span><br><span class="line">        <span class="hljs-comment">// 成功</span></span><br><span class="line">        options.success &amp;&amp; options.success(xhr.responseText)</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// 失败</span></span><br><span class="line">        options.error &amp;&amp; options.fail(status)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// GET 请求</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (options.type === <span class="hljs-string">'GET'</span>) &#123;</span><br><span class="line">    <span class="hljs-comment">// 启动 GET 一个请求，并设置请求地址</span></span><br><span class="line">    xhr.open(<span class="hljs-string">'GET'</span>, options.url + <span class="hljs-string">'?'</span> + params, options.async)</span><br><span class="line">    <span class="hljs-comment">// 发送请求</span></span><br><span class="line">    xhr.send(<span class="hljs-literal">null</span>)</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options.type === <span class="hljs-string">'POST'</span>) &#123;</span><br><span class="line">    <span class="hljs-comment">// POST 请求</span></span><br><span class="line">    xhr.open(<span class="hljs-string">'POST'</span>, options.url, options.async)</span><br><span class="line">    <span class="hljs-comment">// 设置请求头，模拟 POST 表单提交</span></span><br><span class="line">    xhr.setRequestHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/x-www-form-urlencoded'</span>)</span><br><span class="line">    <span class="hljs-comment">// 发送请求</span></span><br><span class="line">    xhr.send(param)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：使用 Node.js 创建服务器，对上面的代码进行简单的测试<br>服务器端代码如下：</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">const http = require(&apos;http&apos;)</span><br><span class="line">const url = require(&apos;url&apos;)</span><br><span class="line"></span><br><span class="line">const server = http.createServer((req, res) =&gt; &#123;</span><br><span class="line">  // GET 处理</span><br><span class="line">  let data = url.parse(req.url, true).query</span><br><span class="line">  res.writeHead(200, &#123;</span><br><span class="line">    &apos;Content-Type&apos;: &apos;text/plain&apos;,</span><br><span class="line">    &apos;Access-Control-Allow-Origin&apos;: &apos;*&apos;</span><br><span class="line">  &#125;)</span><br><span class="line">  res.write(&apos;姓名:&apos; + data.name + &apos;===&apos; + &apos;年龄:&apos; + data.age)</span><br><span class="line">  res.end()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(8080)</span><br></pre></td></tr></table></figure><p>客户端代码如下：</p><figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 测试</span></span><br><span class="line">ajax(&#123;</span><br><span class="line">  url: <span class="hljs-string">'http://localhost:8080/'</span>,</span><br><span class="line">  type: <span class="hljs-string">'GET'</span>,</span><br><span class="line">  data: &#123;</span><br><span class="line">    name: <span class="hljs-string">'tflin'</span>,</span><br><span class="line">    age: <span class="hljs-string">'21'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="hljs-keyword">async</span>: <span class="hljs-literal">true</span>,</span><br><span class="line">  success: <span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'发送成功！'</span>)</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(result)</span><br><span class="line">  &#125;,</span><br><span class="line">  error: <span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'发送失败！'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>启动服务器后，刷新客户端<br><img src="http://pt2js28ws.bkt.clouddn.com/ajax_1.jpg" alt="ajax封装测试"></p><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol><li>Ajax 是无需等待页面就能从服务器获取数据的一种方法。</li><li>Ajax 的核心对象是 XMLHttpRequest 对象，简称 XHR 对象</li><li>POST 请求需要设置请求头，模拟表单提交</li><li>在请求体数据后面加上时间戳或随机数，是为了避免发送相同的数据时 IE 使用缓存</li><li>使用 Ajax 的的步骤为下：</li></ol><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. 创建 XHR 对象</span><br><span class="line">2. 调用 open() 启动一个请求</span><br><span class="line">3. 调用 send() 发送请求</span><br><span class="line">4. 为 xhr 注册 onreadystatechange 时间，监听 readyState 属性的状态(这一步写在 open() 之前，保证浏览器兼容性)</span><br><span class="line">5. readyState 为 4，status 没什么问题时，说明整个 请求/响应 的过程已经成功</span><br></pre></td></tr></table></figure></div><ul class="post-copyright"><li><strong>本文标题：</strong><a href="https://tflin.com/post/2003010830.html">谈谈原生 Ajax</a></li><li><strong>本文作者：</strong><a href="https://tflin.com">tflin</a></li><li><strong>本文链接：</strong><a href="https://tflin.com/post/2003010830.html">https://tflin.com/post/2003010830.html</a></li><li><strong>发布时间：</strong>2018-08-25</li><li><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</li></ul><div class="level is-size-7 is-uppercase"><div class="level-start"><div class="level-item"><i class="fas fa-tags has-text-grey"></i>&nbsp; <a class="has-link-grey -link" href="/tags/Ajax/">Ajax</a>,&nbsp;<a class="has-link-grey -link" href="/tags/JavaScript/">JavaScript</a></div></div></div></div></div><div class="card card-transparent"><div class="level post-navigation is-flex-wrap is-mobile"><div class="level-start"><a class="level level-item has-link-grey article-nav-prev" href="/post/3637177528.html"><i class="level-item fas fa-chevron-left"></i> <span class="level-item">大四学习计划</span></a></div><div class="level-end"><a class="level level-item has-link-grey article-nav-next" href="/post/2587019307.html"><span class="level-item">Node.js + Express + mongodb 的博客项目之总结（十一）</span> <i class="level-item fas fa-chevron-right"></i></a></div></div></div><div class="card"><div class="card-content"><h3 class="title is-5 has-text-weight-normal">PS: 有问题，或者有不同意见，请移步至 <a href="https://github.com/tflins/tflins.github.io/issues" target="_blank">github</a> 提交 issues 进行讨论</h3></div></div></div><div class="column is-4-tablet is-4-desktop is-3-widescreen has-order-1 column-left is-sticky"><div class="card widget column-left is-sticky" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex" href="#前言"><span class="has-mr-6">1</span> <span>前言</span></a></li><li><a class="is-flex" href="#XMLHttpRequest-对象"><span class="has-mr-6">2</span> <span>XMLHttpRequest 对象</span></a></li><li><a class="is-flex" href="#XHR-的用法"><span class="has-mr-6">3</span> <span>XHR 的用法</span></a><ul class="menu-list"><li><a class="is-flex" href="#open-方法："><span class="has-mr-6">3.1</span> <span>open() 方法：</span></a></li><li><a class="is-flex" href="#send-方法"><span class="has-mr-6">3.2</span> <span>send() 方法</span></a></li><li><a class="is-flex" href="#响应数据"><span class="has-mr-6">3.3</span> <span>响应数据</span></a></li><li><a class="is-flex" href="#onreadystatechange-事件与-readyState-属性"><span class="has-mr-6">3.4</span> <span>onreadystatechange 事件与 readyState 属性</span></a></li><li><a class="is-flex" href="#setRequestHeader-、getResponseHeader-与-getAllResponseHeaders-方法"><span class="has-mr-6">3.5</span> <span>setRequestHeader() 、getResponseHeader() 与 getAllResponseHeaders() 方法</span></a></li></ul></li><li><a class="is-flex" href="#GET-请求"><span class="has-mr-6">4</span> <span>GET 请求</span></a></li><li><a class="is-flex" href="#POST-请求"><span class="has-mr-6">5</span> <span>POST 请求</span></a></li><li><a class="is-flex" href="#封装-Ajax"><span class="has-mr-6">6</span> <span>封装 Ajax</span></a></li><li><a class="is-flex" href="#总结"><span class="has-mr-6">7</span> <span>总结</span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start has-text-centered-mobile"><a class="footer-logo is-block has-mb-6" href="/"><img src="/images/logo.png" alt="谈谈原生 Ajax" height="28"></a><p class="is-size-7">&copy; 2021 tflin&nbsp; Powered by <a href="http://tflin.com/" target="_blank">枫林晚记</a></p><p class="is-size-7">本站共计52.6k字</p><p class="is-size-7"><a href="https://beian.miit.gov.cn/" target="_blank">粤ICP备2021076261号-1</a></p></div><div class="level-end"><div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle"><p class="control"><a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-white is-large" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-white is-large" target="_blank" title="Download on GitHub" href="https://github.com/tflins"><i class="fab fa-github"></i></a></p></div></div></div></div><script type="text/javascript" src="https://s9.cnzz.com/z_stat.php?id=1279475949&web_id=1279475949"></script><style>a[title="站长统计"]{display:none}</style></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-CN")</script><script>var IcarusThemeSettings={article:{highlight:{clipboard:!0,fold:""}}}</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script src="/js/gallery.js" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now</a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>document.addEventListener("DOMContentLoaded",(function(){outdatedBrowser({bgColor:"#f25648",color:"#ffffff",lowerThan:"flex"})}))</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><script>document.addEventListener("DOMContentLoaded",(function(){MathJax.Hub.Config({"HTML-CSS":{matchFontHeight:!1},SVG:{matchFontHeight:!1},CommonHTML:{matchFontHeight:!1},tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]]}})}))</script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back-to-top.js" defer></script><script src="/js/main.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..."> <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(无标题)"},CONTENT_URL:"/content.json"}</script><script src="/js/insight.js" defer></script><link rel="stylesheet" href="/css/search.css"><link rel="stylesheet" href="/css/insight.css"><script src="//instant.page/5.1.0" type="module" integrity="sha384-by67kQnR+pyfy8yWP4kPO12fHKRLHZPfEsiSXR8u2IKcTdxD805MGUXBzVPnkLHw"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/z16.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":40},"mobile":{"show":false}});</script></body></html>